# 软件设计文档
##### 小组成员：方铭、徐佳豪、卢卓君

项目主要功能分为手动演奏和自动播放两个功能。项目涉及到前端和后端的开发，主要还是以前端为主，后端主要用来存放音色库和解析mid文件。我们采用的是前后端分开开发方法，先从网上找到相应的音色库的编码并暂时存放在前端的代码中，假设音色库的后端已经搭建好了，建立好映射关系后，就可以将前后端暂时分开，同时开发和调试。

![architecture-brief](images/architecture-brief.png)

根据以上架构，我们可以把项目划分为两个子项目，FE 和 Server，让前端工程师和后端工程师分别管理自己的项目，进行开发工作。接下来详细介绍前端项目和后端项目的技术选型、架构设计以及模块划分。

#### 1、技术选型以及理由
前端采用Typescript+jQuery进行开发，页面采要HTML和CSS实现。

TypeScript是一种由微软开发的自由和开源的编程语言。它是JavaScript的一个超集，而且本质上向这个语言添加了可选的静态类型和基于类的面向对象编程。TypeScript扩展了JavaScript的语法，所以任何现有的JavaScript程序可以不加改变的在TypeScript下工作。TypeScript是为大型应用之开发而设计，而编译时它产生 JavaScript 以确保兼容性。TypeScript 支持为已存在的 JavaScript 库添加类型信息的头文件，扩展了它对于流行的库如 jQuery，MongoDB，Node.js 和 D3.js 的好处。TypeScript的语法和c++比较接近，开发和调试都比原始的JavaScript简单一点。

jQuery是一个快速、简洁的JavaScript框架，是继Prototype之后又一个优秀的JavaScript代码库（或JavaScript框架）。jQuery设计的宗旨是“write Less，Do More”，即倡导写更少的代码，做更多的事情。它封装JavaScript常用的功能代码，提供一种简便的JavaScript设计模式，优化HTML文档操作、事件处理、动画设计和Ajax交互。
jQuery的核心特性可以总结为：具有独特的链式语法和短小清晰的多功能接口；具有高效灵活的css选择器，并且可对CSS选择器进行扩展；拥有便捷的插件扩展机制和丰富的插件。jQuery兼容各种主流浏览器，如IE 6.0+、FF 1.5+、Safari 2.0+、Opera 9.0+等。

我们采用原始的HTML和CSS来实现UI界面的设计，主要因为如果使用框架，会有很多限制。而我们要实现的界面包括键盘的音符的对应关系，界面灵活多变，而且发声不能有延迟，所以我们选择了灵活和简洁的最原始的界面设计方法。

#### 2、架构设计
前端项目主要涉及琴键的页面和发声，typescript需要先编译成js才可以真正执行；我们选择使用gulp来进行热编译和链接各个文件。根据需要将所有的代码统一放在了src文件夹里，然后根据需要分为以下4个包。

* css：界面需要用到的各种样式
* lib：存放不同乐器的音色库对应的mp3格式文件以及可供选择的自动播放的mid格式音乐文件
* ts：项目的typescript源代码，前端都在这个文件夹里进行开发
* server：项目使用node.js搭建后端的代码
* index.html:网页的搭建和索引

开发后的代码需要用gulp来编译，之后会生成一个disk文件夹，里面有相应的js和HTML代码，浏览器打开HTML文件后即可启动程序。程序的前端基本依赖于ts里面的typescript代码。根据功能不同，分为不同的文件，里面包含了不同具体实现好了的类。

面向服务的架构：首先通过BayanKey的类提供乐器琴键的接口，然后通过Bayan的类来构建一个乐器并提供相应的接口；定时用一个时间控制器来提供相应的功能

#### 3、模块划分
* 自动播放：分为时间控制，解析文件，传送相关音色库的编码
* 发声模块：根据相应的键盘按钮映射到琴键，然后获取相应的音色库中的文件并发声。根据建立好的颜色映射关系，改变琴键的颜色。
* 乐器界面：软件主要分为基于巴扬和钢琴的2个界面。根据不同乐器的琴键排布特点来设计硬盘的映射关系。


```txt
├─css: 存放页面所用到的样式
│   ├─index.css：初始页面的样式
│   └─piano.css：切换到钢琴页面时的样式
├─lib: 存放后端处理用到的文件
│   ├─instrument：存放不用乐器所对应的音色库
│   └─可供选择的自动播放mid文件
├─sever：存放服务器代码
│   └─server.ts：后端处理源代码
└─src：前端开发的typescript源码
    ├─Bayan.ts：巴扬的整体设计
    ├─BayanKey.ts：巴扬乐器每个琴键的设计
    ├─ColorMap.ts: 建立音调和颜色的对应关系库  
    ├─dropEven.ts：前端组件
    
```

#### 4、设计模式
* 单例模式：应用中将数据从视图层抽离，放到一个应用全局的位置进行管理，所有页面使用的都是同一份数据。当数据更新的时候所有引用到数据的界面也会同步更新。代码复杂度降低，内存使用情况也得到了优化。该模式基本覆盖到了所有类的调用和声明。
* 面向对象编程：应用中使用了面向对象编程的封装思想，按照实现的功能对各个模块进行了封装。特别是将巴扬和钢琴两种不同的乐器独立出来，单独实现了Bayan.ts和Piano.ts这两个不同的类。这两种乐器差别很大，面向对象的设计，对于琴键的布局以及切换，还有发声的选择和调整，都有很大的帮助。

